import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { InferenceClient } from '@huggingface/inference';
import { HealthStatus as CropHealthStatus } from '../crop/enums/health-status.enum';
import { HealthStatus as LivestockHealthStatus } from '../livestock/enums/health-status.enum';

@Injectable()
export class AiService {
  private model = 'microsoft/git-base-coco';
  private hf: InferenceClient;

  constructor(private readonly configService: ConfigService) {
    const apiToken = this.configService.get<string>('REPLICATE_API_TOKEN');
    this.hf = new InferenceClient(apiToken);
  }

  private base64ToArrayBuffer(base64: string): {
    buffer: ArrayBuffer;
    mimeType: string;
  } {
    // Extract MIME type from the base64 string if present
    const matches = base64.match(/^data:(image\/[\w+\-]+);base64,(.+)$/);

    let mimeType = 'image/jpeg'; // Default MIME type
    let base64Data = base64;

    if (matches) {
      mimeType = matches[1];
      base64Data = matches[2];
    } else if (
      base64.startsWith('data:') &&
      !base64.startsWith('data:image/')
    ) {
      throw new Error('Unsupported data URL format or non-image data');
    } else if (!base64.startsWith('data:')) {
      // If it's just a base64 string without a data URL prefix
      base64Data = base64;
    }

    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }

    // console.log('mimeType', mimeType);
    // console.log('binaryString', binaryString);
    // console.log('bytes', bytes);
    console.log('apiToken', this.configService.get('HF_API_TOKEN'));

    return {
      buffer: bytes.buffer,
      mimeType,
    };
  }

  async detectCropHealth(image: string) {
    const cropStatuses = Object.values(CropHealthStatus).join(', ');
    const prompt = `You are an expert agricultural analyst. Examine the provided image of a crop carefully, focusing on visual indicators such as leaf color, texture, spots, wilting, pest presence, fruit maturity, or signs of harvest readiness.

Classify the crop's health status as exactly one of the following: ${cropStatuses}. Base your classification on clear visual evidence from the image.

Then, return a valid JSON object with:
- "status": The exact status string from the list above.
- "confidence": A number between 0.0 and 1.0 indicating how certain you are, based on the strength and clarity of visual evidence (e.g., 1.0 for obvious features, lower for ambiguous ones).
- "description": A concise explanation (1-2 sentences) of the visual reasoning behind the status, referencing specific image details like "yellowing leaves indicate disease" or "uniform green foliage shows health".
- "recommendation":
  - If status is "Healthy", set to an empty string "".
  - If status is "Harvested", set to "The crop appears ready for harvest; proceed with collection to avoid over-ripening."
  - Otherwise (Diseased, Pest-infested, or Withered), provide a practical 1-2 sentence recommendation on addressing the issue, such as treatment, removal, or monitoring (e.g., "Apply fungicide immediately and remove affected leaves to prevent spread.").

Respond only with the JSON object. Do not include any additional text.

Examples:
For a healthy crop: {"status": "Healthy", "confidence": 0.95, "description": "The leaves are vibrant green with no discoloration, spots, or wilting, indicating vigorous growth.", "recommendation": ""}
For a diseased crop: {"status": "Diseased", "confidence": 0.85, "description": "Brown spots and yellowing edges on multiple leaves suggest fungal infection.", "recommendation": "Isolate affected plants and apply an organic fungicide; monitor for spread over the next 48 hours."}`;

    // Convert base64 to ArrayBuffer and get MIME type
    const { buffer: imageBuffer, mimeType } = this.base64ToArrayBuffer(image);

    const result = await this.hf.imageToText({
      //   provider: 'fal-ai',
      model: this.model,
      data: new Blob([imageBuffer], { type: mimeType }),
      parameters: {
        prompt: prompt,
      },
    });
    return result;
  }

  async detectLivestockHealth(image: string) {
    const livestockStatuses = Object.values(LivestockHealthStatus).join(', ');
    const prompt = `You are an expert veterinary analyst. Carefully examine the provided image of livestock, focusing on visual indicators such as posture, coat condition, eye clarity, skin lesions, breathing patterns, or signs of injury or distress.

Classify the livestock's health status as exactly one of: ${livestockStatuses}. Base your classification on clear visual evidence from the image.

Then, return a valid JSON object with:
- "status": The exact status string from the list above.
- "confidence": A number between 0.0 and 1.0 indicating how certain you are, based on the strength and clarity of visual evidence (e.g., 1.0 for obvious symptoms like visible wounds, lower for ambiguous signs).
- "description": A concise explanation (1-2 sentences) of the visual reasoning behind the status, referencing specific image details like "dull coat and limping suggest injury" or "clear eyes and alert posture indicate health".
- "recommendation":
  - If status is "Healthy", set to an empty string "".
  - If status is "Recovered", set to "Monitor the animal to ensure continued recovery."
  - If status is "Deceased", set to "Remove the animal promptly and follow biosecurity protocols to prevent disease spread."
  - Otherwise (Sick, Injured, or Quarantined), provide a practical 1-2 sentence recommendation, such as consulting a veterinarian, isolating the animal, or treating specific symptoms (e.g., "Administer antibiotics and isolate the animal for Sick status.").

Respond only with the JSON object. Do not include any additional text.

Examples:
For a healthy animal: {"status": "Healthy", "confidence": 0.95, "description": "The animal has a shiny coat, clear eyes, and alert posture, indicating good health.", "recommendation": ""}
For an injured animal: {"status": "Injured", "confidence": 0.90, "description": "Visible limp and a wound on the left leg suggest physical injury.", "recommendation": "Clean and dress the wound, and consult a veterinarian for further assessment."}`;

    // Convert base64 to ArrayBuffer and get MIME type
    const { buffer: imageBuffer, mimeType } = this.base64ToArrayBuffer(image);

    const result = await this.hf.imageToText({
      //   provider: 'fal-ai',
      model: this.model,
      data: new Blob([imageBuffer], { type: mimeType }),
      parameters: {
        prompt: prompt,
      },
    });
    return result;
  }
}
